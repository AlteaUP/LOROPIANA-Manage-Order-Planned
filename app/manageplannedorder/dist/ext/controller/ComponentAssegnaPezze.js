sap.ui.define(["sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/BusyIndicator"],function(e,t,n,a){"use strict";return{showMessageConfirm:function(e){e=e.charAt(0).toUpperCase()+e.slice(1);return new Promise((t,a)=>n.confirm("Are you sure you want to "+e+"?",{title:"Confirmation",onClose:function(e){if(e===n.Action.OK)t();else a()}}))},doAssegnaPezze:function(t){const n=new e;const a="manageplannedorder.manageplannedorder::ZZ1_CombinedPlnOrdersAPI_to_CombinPlannedOrdersComObjectPage--fe::table::to_ZZ1_CombPlnOrdersStock::LineItem::Stock-innerTable";const o=this.getBindingContext().getObject();const s=this._view.byId(a).getSelectedItems();const i=this._controller.getOwnerComponent().getModel();const r=[];let l=0;let d=0;for(let e=0;e<s.length;e++){const t=s[e].getBindingContext().getObject();l+=parseInt(t.CombPlanAllQty);r.push(t)}d=parseInt(o.RequiredQuantity)-l;n.setData({...o,TotalPlanAllQty:l.toFixed(3).toString(),OpenQty:d.toFixed(3).toString(),selectedItems:r});this._controller.getView().setModel(n,"selectedPezze");if(!this._fragmentPezze){this._fragmentPezze=this.loadFragment({id:"fragmentPezze",name:"manageplannedorder.manageplannedorder.ext.fragment.Pezze",controller:this._controller})}this._fragmentPezze.then(function(e){e.setModel(n,"selected");e.setModel(i);const t=e.getContent().at(-1);t.bindAggregation("items",{path:"/ZZ1_MFP_ASSIGNMENT",filters:[new sap.ui.model.Filter("FSH_MPLO_ORD",sap.ui.model.FilterOperator.EQ,o.CplndOrd),new sap.ui.model.Filter("MATNR",sap.ui.model.FilterOperator.EQ,o.Material)],template:new sap.m.ColumnListItem({cells:[new sap.m.ObjectIdentifier({title:"{CHARG}"}),new sap.m.Text({text:"{LGORT}"}),new sap.m.Text({text:"{FABB_TOT_V}"}),new sap.m.Text({text:"{COPERTURA}"}),new sap.m.Input({value:"{QTA_ASS_V}"})]}),templateShareable:false,parameters:{$$updateGroupId:"CreatePezzeBatch"}});const a=t.getBinding("items");a.resetChanges();a.attachDataReceived(async function(){await a.requestContexts(0,1);const e=r.reduce((e,t)=>e+parseInt(t.AvaibilityQty||0),0);console.log("Total Availability Quantity: ",e);r.forEach(t=>{const n=structuredClone(t);const s=Math.round(parseInt(n.AvaibilityQty)/e*100);const i=Math.min(parseInt(o.AvailableQuantity),o.AvailableQuantity*(s/100));const r=crypto.randomUUID();const l=structuredClone({SAP_UUID:r,WERKS:n.Plant,LGORT:n.StorageLocation||"X",FSH_MPLO_ORD:o.CplndOrd,BAGNI:n.dye_lot||"X",MATNR:n.Material,CHARG:n.Batch,Bagno:n.dye_lot,QTA_ASS_V:i.toFixed(3).toString(),QTA_ASS_U:"",QTA_ASS_U_Text:"",FABB_TOT_V:n.AvaibilityQty||0,FABB_TOT_U:"",FABB_TOT_U_Text:"",COPERTURA:s,SORT:0,SAP_CreatedDateTime:new Date,SAP_CreatedByUser:"LASPATAS",SAP_CreatedByUser_Text:"",SAP_LastChangedDateTime:new Date,SAP_LastChangedByUser:"LASPATAS",SAP_LastChangedByUser_Text:"X"});const d=a.getContexts().some(e=>e.getObject().CHARG===t.Batch);if(!d){console.warn("Combined planned order is not present in binding.");a.create(l,false,false,false)}else{console.log("Combined planned order is present in binding.")}});t.invalidate()}.bind(this));e.open()}.bind(this))},doDisassignPezze:async function(e){const n=this.getBindingContext().getObject();const o=this._controller.getOwnerComponent().getModel();const s=o.bindList("/ZZ1_MFP_ASSIGNMENT");const i=new sap.ui.model.Filter("FSH_MPLO_ORD",sap.ui.model.FilterOperator.EQ,n.CplndOrd);const r=new sap.ui.model.Filter("MATNR",sap.ui.model.FilterOperator.EQ,n.Material);s.filter([i,r]);a.show(0);const l=await s.requestContexts(0,20);const d=l.map(e=>e);if(!d.length){t.show("No items to disassemble.");a.hide(0);return}try{await this._controller.showMessageConfirm(`disassemble (${d.length})`)}catch(e){t.show("Disassemble cancelled.");a.hide(0);return}const c="DisassemblePezzeBatch";d.forEach(function(e){e.delete(c)});const m=await o.submitBatch(c);a.hide(0);const g=sap.ui.getCore().byId("manageplannedorder.manageplannedorder::ZZ1_CombinedPlnOrdersAPI_to_CombinPlannedOrdersComObjectPage--fe::table::to_ZZ1_CombPlnOrdersStock::LineItem::Stock-innerTable");if(!m){t.show("Disassemble completed successfully.");g.refreshItems();g.getBinding("items").refresh();const e=sap.ui.getCore().byId("manageplannedorder.manageplannedorder::ZZ1_CombinedPlnOrdersAPI_to_CombinPlannedOrdersComObjectPage--fe::HeaderFacet::KeyFigure::TotalProdAllQty");e.getBindingContext().refresh()}else{t.show("Disassemble failed.")}},doWhereUsed:function(t){const n=this.getBindingContext().getObject();const a=this._controller.getOwnerComponent().getModel();const o=new e;o.setData({...n});this._controller.getView().setModel(o,"selectedWhereUsed");if(!this._fragmentWhereUsed){this._fragmentWhereUsed=this.loadFragment({id:"fragmentPezze",name:"manageplannedorder.manageplannedorder.ext.fragment.WhereUsed",controller:this._controller})}this._fragmentWhereUsed.then(function(e){e.setModel(o,"selected");e.setModel(a);const t=e.getContent().at(-1);t.bindAggregation("items",{path:"/ZZ1_CombPlnOrdersStockAPI",filters:[new sap.ui.model.Filter("CplndOrd",sap.ui.model.FilterOperator.NE,n.CplndOrd),new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,n.Material),new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,n.Plant)],template:new sap.m.ColumnListItem({cells:[new sap.m.ObjectIdentifier({title:"{CplndOrd}"}),new sap.m.Text({text:"{AvailableQuantity}"})]}),templateShareable:true});const s=t.getBinding("items");s.resetChanges();e.open()}.bind(this))},onCloseDialog:function(e){const t=e.getSource().getParent();t.close()},formatAvaibilityQty:function(e){return e}}});
//# sourceMappingURL=ComponentAssegnaPezze.js.map